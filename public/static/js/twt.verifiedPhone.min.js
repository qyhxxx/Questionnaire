(function(exports){if(!exports.twt)exports.twt={};var twt=exports.twt;var apiPrefix="//login.twtstudio.com";var config={mode:"cors",credentials:"include",headers:{Accept:"application/json"}};var $el=window.$el;var $fields=["verify","captcha","phone"];var VerifiedPhone=function(domQuery){this.$dom={};this.$dom.root=document.querySelector(domQuery);this.verifyData={};this.timer=null;this.lock=false};twt.VerifiedPhone=VerifiedPhone;var verifiedPhone=VerifiedPhone.prototype;var renderStandardFieldGroup=function(label,inputAttr){var dom={};dom.input=$el({tagName:"input",className:"twt-form-control",attributes:inputAttr});dom.error=$el({tagName:"div",className:"twt-s-danger"});dom.main=$el({tagName:"div",className:"twt-col-md-10",childs:[dom.input,dom.error]});dom.wrap=$el({tagName:"fieldset",className:"twt-form-group twt-row",childs:[{tagName:"label",className:"twt-col-md-2 twt-form-control-label",text:label},dom.main]});return dom};var renderButton=function(text,className){return $el({tagName:"a",className:"twt-btn "+className,attributes:{href:"javascript:void(0)"},text:text})};verifiedPhone.updateCaptcha=function(){this.$dom.captcha.image.src=apiPrefix+"/captcha/"+this.verifyData.key+"?r="+Math.random()};verifiedPhone.processError=function(err){var self=this;$fields.forEach(function(id){self.$dom[id].wrap.className=self.$dom[id].wrap.className.replace(/\s*twt-has-danger\s*/g," ");if(err[id]&&err[id].length){self.$dom[id].wrap.className+=" twt-has-danger";self.$dom[id].error.textContent=err[id].join(", ")}else{self.$dom[id].error.textContent=""}});if(err.key&&err.key.length){if(err.key.indexOf(":verify_captcha_reload:")!==-1){self.updateCaptcha()}if(err.key.indexOf(":verify_need_restart:")!==-1){self.onRestart()}}};verifiedPhone.startTimer=function(){if(this.timer===null)this.timer=120;if(this.timer<=0){this.$dom.verify.mode.style.display="";this.$dom.verify.timer.style.display="none";this.timer=null;return}this.$dom.verify.timer.textContent=this.timer+" 秒后重发";--this.timer;var self=this;setTimeout(function(){self.startTimer()},1e3)};verifiedPhone.doVerify=function(mode){if(this.lock||this.verifyData.signed)return;this.lock=true;var self=this;var data={mode:mode,key:this.verifyData.key};$fields.forEach(function(id){data[id]=self.$dom[id].input.value});var status=1;var err={captcha:[]};if(mode!=="sms"&&mode!=="voice"){status=0;err.captcha.push("非法请求")}if(data.phone.length!==11||!/1\d{10}/.test(data.phone)){status=0;err.phone=["请输入中国大陆 11 位手机号"]}if(!data.captcha){status=0;err.captcha.push("请输入验证码")}if(!status){this.lock=false;this.processError(err);return}this.processError({});twt.fetch(apiPrefix+"/api/verifiedPhone/request",config).body(data).then(function(res){return res.json()}).then(function(data){if(data.status){self.$dom.verify.mode.style.display="none";self.$dom.verify.timer.style.display="";self.startTimer()}else{self.processError(data.error)}}).finally(function(){self.lock=false})};verifiedPhone.doCheck=function(){if(this.lock||this.verifyData.signed)return;this.lock=true;var data={key:this.verifyData.key,verify:this.$dom.verify.input.value};if(!data.verify){this.lock=false;this.processError({verify:["请输入验证码"]});return}this.processError({});var self=this;twt.fetch(apiPrefix+"/api/verifiedPhone/check",config).body(data).then(function(res){return res.json()}).then(function(data){if(data.status){self.$dom.verify.wrap.style.display="none";self.$dom.captcha.wrap.style.display="none";self.$dom.phone.edit.style.display="";self.$dom.phone.input.setAttribute("readonly",true);self.onComplete(data);self.$dom.phone.input.value=data.phone;self.$dom.hidden.time.value=data.time;self.$dom.hidden.token.value=data.token;self.$dom.hidden.sign.value=data.sign}else{self.processError(data.error)}}).finally(function(){self.lock=false})};verifiedPhone.start=function(query){var self=this;twt.fetch(apiPrefix+"/api/verifiedPhone/start?"+query,config).method("post").then(function(res){return res.json()}).then(function(data){if(data.status){self.verifyData.key=data.key;self.updateCaptcha()}else{window.alert("VerifiedPhone failed to initialize.")}})};verifiedPhone.reset=function(){this.$dom.verify.wrap.style.display="";this.$dom.captcha.wrap.style.display="";this.$dom.phone.edit.style.display="none";this.$dom.phone.input.remove.removeAttribute("readonly");this.$dom.captcha.input.value="";this.$dom.verify.input.value="";this.$dom.phone.input.value="";this.$dom.hidden.time.value="";this.$dom.hidden.token.value="";this.$dom.hidden.sign.value="";if(this.timer!==null){this.timer=-1}this.processError({});this.onRestart()};verifiedPhone.render=function(){this.$dom.captcha=renderStandardFieldGroup("请输入图中字符",{style:"width:150px"});this.$dom.captcha.image=$el({tagName:"img",attributes:{style:"height: 60px"}});this.$dom.captcha.image.addEventListener("click",this.updateCaptcha.bind(this));this.$dom.captcha.main.appendChild(this.$dom.captcha.image);this.$dom.root.appendChild(this.$dom.captcha.wrap);this.$dom.phone=renderStandardFieldGroup("手机号",{name:"phone",type:"tel",style:"width:150px"});var $phone=this.$dom.phone;$phone.wrap.className+=" twt-form-inline";$phone.edit=renderButton("修改","twt-btn-primary twt-m-l-1");$phone.edit.style.display="none";$phone.edit.addEventListener("click",this.reset.bind(this));$phone.main.insertBefore($phone.edit,$phone.error);this.$dom.root.appendChild($phone.wrap);this.$dom.verify=renderStandardFieldGroup("验证码");var $verify=this.$dom.verify;$verify.wrap.className+=" twt-form-inline";$verify.sms=renderButton("短信","twt-btn-primary twt-m-l-1");$verify.sms.addEventListener("click",this.doVerify.bind(this,"sms"));$verify.voice=renderButton("语音","twt-btn-success twt-m-l-1");$verify.voice.addEventListener("click",this.doVerify.bind(this,"voice"));$verify.mode=$el({tagName:"span",childs:[$verify.sms,$verify.voice]});$verify.main.insertBefore($verify.mode,$verify.error);$verify.timer=$el({tagName:"span",attributes:{style:"display: none"},text:"120 秒后重发"});$verify.main.insertBefore($verify.timer,$verify.error);$verify.check=renderButton("确定","twt-btn-primary twt-m-t-2");$verify.check.addEventListener("click",this.doCheck.bind(this));$verify.main.appendChild($verify.check);this.$dom.root.appendChild($verify.wrap);this.$dom.hidden={};var $hidden=this.$dom.hidden;$hidden.time=$el({tagName:"input",attributes:{name:"verify-time",type:"hidden"}});this.$dom.root.appendChild($hidden.time);$hidden.token=$el({tagName:"input",attributes:{name:"verify-token",type:"hidden"}});this.$dom.root.appendChild($hidden.token);$hidden.sign=$el({tagName:"input",attributes:{name:"verify-sign",type:"hidden"}});this.$dom.root.appendChild($hidden.sign)};verifiedPhone.onRestart=function(){console.warn("[TwT.VerifiedPhone] Using built-in onRestart callback. ")};verifiedPhone.onComplete=function(data){console.warn("[TwT.VerifiedPhone] Using built-in onComplete callback. ");console.log(data)}})(typeof window!=="undefined"?window:this);